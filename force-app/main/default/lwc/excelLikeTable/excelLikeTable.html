<template>
    <div class="slds-card">
        <!-- Loading Spinner -->
        <template lwc:if={isLoading}>
            <div class="slds-spinner_container">
                <div role="status" class="slds-spinner slds-spinner_medium">
                    <span class="slds-assistive-text">Loading...</span>
                    <div class="slds-spinner__dot-a"></div>
                    <div class="slds-spinner__dot-b"></div>
                </div>
            </div>
        </template>

        <!-- Error Display -->
        <template lwc:if={error}>
            <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
                <span class="slds-assistive-text">error</span>
                <h2>{error}</h2>
            </div>
        </template>

        <!-- Main Content -->
        <template lwc:if={isNotLoading}>
            <!-- Controls Bar -->
            <div class="slds-card__header slds-grid slds-wrap">
                <!-- Row 1: Buttons -->
                <div class="slds-col slds-size_1-of-1 slds-m-bottom_small">
                    <div class="slds-button-group" role="group">
                        <button class="slds-button slds-button_neutral" class:slds-button_brand={isInlineEditMode}
                            onclick={handleToggleInlineEdit} aria-pressed={isInlineEditMode}>
                            {inlineEditButtonLabel}
                        </button>
                        <button class="slds-button slds-button_neutral" onclick={handleHideSelected}
                            disabled={hasNoSelectedRows}>
                            Hide Selected
                        </button>
                        <button class="slds-button slds-button_neutral" onclick={handleHideUnselected}
                            disabled={hasNoSelectedRows}>
                            Hide Unselected
                        </button>
                        <button class="slds-button slds-button_neutral" onclick={handleUnhideAll}
                            disabled={hasNoHiddenRows}>
                            Unhide All
                        </button>
                    </div>

                    <!-- Hidden rows indicator -->
                    <template lwc:if={hasHiddenRows}>
                        <span class="slds-badge slds-badge_inverse slds-m-left_small">
                            {hiddenRowsMessage}
                        </span>
                    </template>
                </div>

                <!-- Row 2: Search -->
                <div class="slds-col slds-size_1-of-1 slds-size_1-of-3_medium">
                    <div class="slds-form-element">
                        <div class="slds-form-element__control slds-input-has-icon slds-input-has-icon_left-right">
                            <svg class="slds-icon slds-input__icon slds-input__icon_left slds-icon-text-default"
                                aria-hidden="true">
                                <use xlink:href="/_slds/icons/utility-sprite/svg/symbols.svg#search"></use>
                            </svg>
                            <input type="text" data-id="search-input" class="slds-input"
                                placeholder="Search all columns..." oninput={handleSearchInput}
                                aria-label="Search table">
                            <template lwc:if={showSearchClear}>
                                <button class="slds-button slds-button_icon slds-input__icon slds-input__icon_right"
                                    onclick={handleClearSearch} title="Clear search">
                                    <svg class="slds-button__icon" aria-hidden="true">
                                        <use xlink:href="/_slds/icons/utility-sprite/svg/symbols.svg#clear"></use>
                                    </svg>
                                    <span class="slds-assistive-text">Clear search</span>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="slds-card__body slds-card__body_inner table-container">
                <table class={tableClasses} role="grid" aria-label="Excel-like editable table">
                    <!-- Table Header -->
                    <thead>
                        <tr class="slds-line-height_reset">
                            <!-- Checkbox column header -->
                            <th class="slds-text-align_center checkbox-column" scope="col">
                                <div class="">
                                    <span class="slds-checkbox">
                                        <input type="checkbox" id="select-all-checkbox" checked={selectAllChecked}
                                            indeterminate={selectAllIndeterminate} onchange={handleSelectAll}>
                                        <label class="slds-checkbox__label" for="select-all-checkbox">
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-form-element__label slds-assistive-text">Select All</span>
                                        </label>
                                    </span>
                                </div>
                            </th>

                            <!-- Data column headers -->
                            <template for:each={displayColumns} for:item="col">
                                <th key={col.field_api} scope="col" class="slds-is-sortable column-header"
                                    data-field-api={col.field_api} ondblclick={handleHeaderDoubleClick}
                                    aria-label={col.label}>

                                    <!-- Normal header display -->
                                    <template lwc:if={col.isNotEditing}>
                                        <div class="slds-th__action slds-th__action_form cell-inner-content">
                                            <span class="slds-truncate" title={col.label}>{col.label}</span>
                                            <span class="slds-assistive-text">Double-click to edit column</span>
                                        </div>
                                    </template>

                                    <!-- Header editing mode -->
                                    <template lwc:if={col.isEditing}>
                                        <div class="slds-grid slds-grid_vertical-align-center header-edit-container">
                                            <!-- Text input -->
                                            <template lwc:if={col.isText}>
                                                <input type="text" class="slds-input slds-input_small header-edit-input"
                                                    data-header-input={col.field_api} data-field-api={col.field_api}
                                                    value={headerEditValue} oninput={handleHeaderEditChange}
                                                    onkeydown={handleHeaderEditKeydown} aria-label="Edit column value">
                                            </template>

                                            <!-- Number input -->
                                            <template lwc:if={col.isNumber}>
                                                <input type="number"
                                                    class="slds-input slds-input_small header-edit-input"
                                                    data-header-input={col.field_api} data-field-api={col.field_api}
                                                    value={headerEditValue} oninput={handleHeaderEditChange}
                                                    onkeydown={handleHeaderEditKeydown} aria-label="Edit column value">
                                            </template>

                                            <!-- Picklist dropdown -->
                                            <template lwc:if={col.isPicklist}>
                                                <select class="slds-select header-edit-input"
                                                    data-header-input={col.field_api} data-field-api={col.field_api}
                                                    onchange={handleHeaderEditChange}
                                                    onkeydown={handleHeaderEditKeydown} aria-label="Edit column value">
                                                    <option value="">--Select--</option>
                                                    <template for:each={headerEditPicklistOptions} for:item="opt">
                                                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                                                    </template>
                                                </select>
                                            </template>

                                            <!-- Date input -->
                                            <template lwc:if={col.isDate}>
                                                <input type="date" class="slds-input slds-input_small header-edit-input"
                                                    data-header-input={col.field_api} data-field-api={col.field_api}
                                                    value={headerEditValue} oninput={handleHeaderEditChange}
                                                    onkeydown={handleHeaderEditKeydown} aria-label="Edit column value">
                                            </template>

                                            <!-- Boolean checkbox -->
                                            <template lwc:if={col.isBoolean}>
                                                <span class="slds-checkbox cell-checkbox-input">
                                                    <input type="checkbox" id={col.headerBooleanId}
                                                        data-header-input={col.field_api} data-field-api={col.field_api}
                                                        checked={headerEditValue} onchange={handleHeaderEditChange}
                                                        onkeydown={handleHeaderEditKeydown}>
                                                    <label class="slds-checkbox__label" for={col.headerBooleanId}>
                                                        <span class="slds-checkbox_faux"></span>
                                                    </label>
                                                </span>
                                            </template>

                                            <!-- Apply button -->
                                            <button
                                                class="slds-button slds-button_icon slds-button_icon-brand slds-m-left_xx-small"
                                                data-field-api={col.field_api} onclick={handleHeaderEditApply}
                                                title="Apply to rows">
                                                <svg class="slds-button__icon" aria-hidden="true">
                                                    <use xlink:href="/_slds/icons/utility-sprite/svg/symbols.svg#check">
                                                    </use>
                                                </svg>
                                                <span class="slds-assistive-text">Apply</span>
                                            </button>
                                        </div>
                                    </template>
                                </th>
                            </template>
                        </tr>
                    </thead>

                    <!-- Table Body -->
                    <tbody>
                        <template for:each={displayRows} for:item="row">
                            <tr key={row.Id} class="slds-hint-parent">
                                <!-- Row checkbox -->
                                <td class="slds-text-align_center checkbox-column">
                                    <span class="slds-checkbox">
                                        <input type="checkbox" id={row._rowCheckboxId} data-row-id={row.Id}
                                            checked={row._isSelected} onchange={handleRowSelect}>
                                        <label class="slds-checkbox__label" for={row._rowCheckboxId}>
                                            <span class="slds-checkbox_faux"></span>
                                            <span class="slds-form-element__label slds-assistive-text">Select row</span>
                                        </label>
                                    </span>
                                </td>

                                <!-- Data cells -->
                                <template for:each={row._cells} for:item="cell">
                                    <td key={cell.cellKey} class:slds-is-edited={cell.isEdited}
                                        data-cell-key={cell.cellKey}>

                                        <!-- View Mode -->
                                        <template lwc:if={isNotInlineEditMode}>
                                            <!-- Boolean: show disabled checkbox -->
                                            <template lwc:if={cell.isBoolean}>
                                                <span class="slds-checkbox">
                                                    <input type="checkbox" id={cell.cellBooleanId} checked={cell.value}
                                                        disabled>
                                                    <label class="slds-checkbox__label" for={cell.cellBooleanId}>
                                                        <span class="slds-checkbox_faux"></span>
                                                    </label>
                                                </span>
                                            </template>
                                            <!-- Non-boolean: show text value -->
                                            <template lwc:if={cell.isNotBoolean}>
                                                <span class="cell-value">{cell.displayValue}</span>
                                            </template>
                                        </template>

                                        <!-- Edit Mode -->
                                        <template lwc:if={isInlineEditMode}>
                                            <!-- Text input -->
                                            <template lwc:if={cell.isText}>
                                                <input type="text" class="slds-input slds-input_small cell-input"
                                                    data-row-id={row.Id} data-field-api={cell.fieldApi}
                                                    value={cell.value} onchange={handleCellChange}
                                                    onkeydown={handleCellKeydown} aria-label={cell.fieldApi}>
                                            </template>

                                            <!-- Number input -->
                                            <template lwc:if={cell.isNumber}>
                                                <input type="number" class="slds-input slds-input_small cell-input"
                                                    data-row-id={row.Id} data-field-api={cell.fieldApi}
                                                    value={cell.value} onchange={handleCellChange}
                                                    onkeydown={handleCellKeydown} step="0.01"
                                                    aria-label={cell.fieldApi}>
                                            </template>

                                            <!-- Picklist dropdown -->
                                            <template lwc:if={cell.isPicklist}>
                                                <select class="slds-select cell-input" data-row-id={row.Id}
                                                    data-field-api={cell.fieldApi} onchange={handleCellChange}
                                                    onkeydown={handleCellKeydown} aria-label={cell.fieldApi}>
                                                    <option value="">--Select--</option>
                                                    <template for:each={cell.picklistOptions} for:item="opt">
                                                        <option key={opt.value} value={opt.value}
                                                            selected={opt.selected}>
                                                            {opt.label}
                                                        </option>
                                                    </template>
                                                </select>
                                            </template>

                                            <!-- Date input -->
                                            <template lwc:if={cell.isDate}>
                                                <input type="date" class="slds-input slds-input_small cell-input"
                                                    data-row-id={row.Id} data-field-api={cell.fieldApi}
                                                    value={cell.value} onchange={handleCellChange}
                                                    onkeydown={handleCellKeydown} aria-label={cell.fieldApi}>
                                            </template>

                                            <!-- Boolean checkbox -->
                                            <template lwc:if={cell.isBoolean}>
                                                <span class="slds-checkbox">
                                                    <input type="checkbox" id={cell.cellBooleanId} data-row-id={row.Id}
                                                        data-field-api={cell.fieldApi} checked={cell.value}
                                                        onchange={handleCellChange} onkeydown={handleCellKeydown}>
                                                    <label class="slds-checkbox__label" for={cell.cellBooleanId}>
                                                        <span class="slds-checkbox_faux"></span>
                                                    </label>
                                                </span>
                                            </template>
                                        </template>
                                    </td>
                                </template>
                            </tr>
                        </template>

                        <!-- Empty state -->
                        <template lwc:if={hasNoDisplayRows}>
                            <tr>
                                <td colspan="100" class="slds-text-align_center slds-p-around_medium">
                                    <p class="slds-text-body_regular slds-text-color_weak">
                                        No records to display
                                    </p>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Footer info -->
            <div class="slds-card__footer">
                <span class="slds-text-body_small slds-text-color_weak">
                    Showing {visibleRowCount} of {totalRowCount} records
                </span>
            </div>
        </template>
    </div>
</template>